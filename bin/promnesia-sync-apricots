#!/usr/bin/env bash
set -e -o pipefail
set -xv
source_home="$HOME"
backup_home="/Users/rmi1"
source_promnesia_dir="${source_home}/Library/Application Support/promnesia"
backup_promnesia_dir="${backup_home}/Library/Application Support/promnesia"
source_db=promnesia.sqlite
backup_db=promnesia-apricots.sqlite
source_config=config.py
backup_config=config-apricots.py

cd "$source_promnesia_dir"
sqlite3 "$source_db" ".backup ${backup_db}"
sqlite3 "$backup_db" <<EOF
UPDATE
    visits
SET
    locator_href = REPLACE(locator_href, '${source_home}', '${backup_home}')
WHERE
    src in ('home-org', 'tiktok-org', 'exobrain');
UPDATE
    visits
SET
    locator_title = REPLACE(locator_title, '${source_promnesia_dir}', '${backup_promnesia_dir}'),
    locator_href = REPLACE(locator_href, '${source_promnesia_dir}', '${backup_promnesia_dir}')
WHERE
    src in ('chrome-history-personal', 'chrome-history-corp');
EOF
cp "$source_config" "$backup_config"
sed -i '' -e "s|${source_promnesia_dir}|${backup_promnesia_dir}|g" \
    -e "s|${source_home}|${backup_home}|g" "$backup_config"
ssh apricots "mkdir -p \"${backup_promnesia_dir}\""
rsync -a "$backup_db" apricots:"${backup_promnesia_dir}/${source_db}" &
rsync -a "$backup_config" apricots:"${backup_promnesia_dir}/${source_config}" &
rsync -a chrome-history-export-personal/ apricots:"${backup_promnesia_dir}/chrome-history-export-personal" &
rsync -a chrome-history-export-corp/ apricots:"${backup_promnesia_dir}/chrome-history-export-corp" &
wait
