#!/usr/bin/env perl
# Push org file repositories
use 5.012;
use strict;
use warnings;

my @org_repos = split /\s+/, $ENV{'ORG_REPOS'} // die "No repos defined";
my $git = $ENV{GIT} // 'git';
$git = shellescape($git);

for my $repo (@org_repos) {
    chdir "$ENV{HOME}/Documents/org/$repo";
    my $oldbranch = `$git rev-parse --abbrev-ref HEAD`;
    chomp $oldbranch;
    $oldbranch = shellescape($oldbranch);
    system("$git stash save -q");
    system("$git checkout -q master");
    system("$git pull -q");
    # Filter stderr to remove spurious messages
    system(qq{GIT=$git bash -c '\$GIT push -q }
        . qq{2> >( sed "/Resolving deltas/d" )'});
    system("$git checkout -q $oldbranch");
    length `$git stash list` and system("$git stash apply -q");
}

sub shellescape {
    my $arg = shift;
    $arg =~ s/'/'\\''/g;
    return "'" . $arg . "'";
}
