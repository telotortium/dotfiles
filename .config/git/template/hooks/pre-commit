#!/usr/bin/env bash
# File generated by pre-commit: https://pre-commit.com
# ID: 138fd403232d2ddd5efb44317e38bf03

set -eu -o pipefail

# Check if repo has less than 1 commit (inspired by
# https://stackoverflow.com/a/5492347/207384). If so, copy the
# .pre-commit-config.yaml if not present already and re-execute.
if [[ "$(git rev-list -n 2 --all | wc -l)" -lt 1 ]]; then
    # Copy default .pre-commit-config.yaml if it's not already present
    if ! [[ -r .pre-commit-config.yaml ]]; then
        cp -n ~/.config/git/template/.pre-commit-config.yaml \
            .pre-commit-config.yaml
        echo "Copied default .pre-commit-config.yaml" 1>&2
        exec "$0" "$@"
    fi
fi

# start templated
INSTALL_PYTHON=
ARGS=(hook-impl --config=.pre-commit-config.yaml --hook-type=pre-commit --skip-on-missing-config)
# end templated

HERE="$(cd "$(dirname "$0")" && pwd)"
ARGS+=(--hook-dir "$HERE" -- "$@")
if [ -t /dev/tty ]; then OUT=/dev/tty; else OUT=/dev/stdout; fi

filter_out_passed_skipped () {
    (
        set +e
        grep -E -v '(Passed|Skipped)('$'\E''\[m)?$' >"$OUT"
        rv=$?
        if [ $rv -le 1 ]; then return 0; else return $rv; fi
    )
}

# 1. If INSTALL_PYTHON is already set, use that.
# 2. Otherwise, use `pre-commit` CLI command if available.
# 3. Otherwise, re-exec this script using python3 on PATH. If that succeeds,
#    rewrite this script to set that python3 as INSTALL_PYTHON.
if [ -x "$INSTALL_PYTHON" ] && "$INSTALL_PYTHON" -mpre_commit -V &>/dev/null; then
    "$INSTALL_PYTHON" -mpre_commit "${ARGS[@]}" | filter_out_passed_skipped
elif command -v pre-commit > /dev/null; then
    pre-commit "${ARGS[@]}" | filter_out_passed_skipped
elif [ -z "$INSTALL_PYTHON" ]; then
    sed_script='s!^INSTALL_PYTHON=.*$!'$(printf 'INSTALL_PYTHON=%q' "$(which python3)")'!'
    set +e
    sed -e "$sed_script" < "$0" | "$SHELL" -s "$@"
    rv=$?
    set -e
    if [ "$rv" -eq 0 ] && [ -f "$0" ] && ! [ -L "$0" ]; then
        sed -i .orig -e "$sed_script" "$0"
    fi
else
    echo '`pre-commit` not found.  Did you forget to activate your virtualenv?' 1>&2
    exit 1
fi
