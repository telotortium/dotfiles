#!/usr/bin/env bash

# File generated by pre-commit: https://pre-commit.com
# ID: 138fd403232d2ddd5efb44317e38bf03

set -eu -o pipefail

# This value of `$1` is the null-ref from githooks(5) - see
# https://stackoverflow.com/a/73000183/207384.
if [[ "$1" = "$(git hash-object -t tree --stdin </dev/null | sed s/./0/g)" ]]; then
    # Set user.email specially for work repositories.
    if [[ "$(git config remote."$(git config branch."$(git branch --show-current)".remote)".url)" =~ "code.byted.org" ]]; then
        git config user.name "Robert Irelan"
        git config user.email "robert.irelan@bytedance.com"
    fi
fi

# start templated
INSTALL_PYTHON=/opt/local/Library/Frameworks/Python.framework/Versions/3.11/bin/python3.11
ARGS=(hook-impl --config=.pre-commit-config.yaml --hook-type=post-checkout --skip-on-missing-config)
# end templated

HERE="$(cd "$(dirname "$0")" && pwd)"
ARGS+=(--hook-dir "$HERE" -- "$@")
if [ -t /dev/tty ]; then OUT=/dev/tty; else OUT=/dev/stdout; fi

filter_out_passed_skipped () {
    (
        set +e
        grep -E -v '(Passed|Skipped)('$'\E''\[m)?$' >"$OUT"
        rv=$?
        if [ $rv -le 1 ]; then return 0; else return $rv; fi
    )
}

if [ -x "$INSTALL_PYTHON" ]; then
    "$INSTALL_PYTHON" -mpre_commit "${ARGS[@]}" | filter_out_passed_skipped
elif command -v pre-commit > /dev/null; then
    pre-commit "${ARGS[@]}" | filter_out_passed_skipped
else
    echo '`pre-commit` not found.  Did you forget to activate your virtualenv?' 1>&2
    exit 1
fi
